name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build_windows:
    runs-on: windows-latest
    environment: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows installer
        shell: pwsh
        run: npm run tauri -- build --bundles msi

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: src-tauri/target/release/bundle/msi/*.msi

  release:
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build_windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-msi
          path: release-artifacts


      - name: Build release notes
        run: |
          set -euo pipefail
          LAST_TAG=$(git tag --sort=-version:refname | head -n 1 || true)
          RANGE_END="${GITHUB_SHA}"
          if [ -n "$LAST_TAG" ]; then
            git log "${LAST_TAG}..${RANGE_END}" --pretty=format:"%s" > release-artifacts/release-commits.txt
          else
            git log "${RANGE_END}" --pretty=format:"%s" > release-artifacts/release-commits.txt
          fi

          python3 - <<'PY'
          import re
          from pathlib import Path

          lines = Path("release-artifacts/release-commits.txt").read_text().splitlines()
          pattern = re.compile(r"^(feat|fix|perf)(?:\([^)]*\))?:\s*(.+)$", re.IGNORECASE)
          groups = {"feat": [], "fix": [], "perf": []}
          for line in lines:
              match = pattern.match(line.strip())
              if not match:
                  continue
              kind = match.group(1).lower()
              message = match.group(2).strip()
              if message:
                  groups[kind].append(message)

          sections = [
              ("## New Features", "feat"),
              ("## Fixes", "fix"),
              ("## Performance Improvements", "perf"),
          ]
          output = []
          for title, key in sections:
              items = groups[key]
              if not items:
                  continue
              output.append(title)
              output.extend([f"- {item}" for item in items])
              output.append("")

          notes = "\n".join(output).strip()
          if not notes:
              notes = "- No user-facing changes."

          Path("release-artifacts/release-notes.md").write_text(notes + "\n")
          PY

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION=$(python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("src-tauri/tauri.conf.json").read_text())
          print(data["version"])
          PY
          )

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes-file release-artifacts/release-notes.md \
            --target "$GITHUB_SHA" \
            release-artifacts/*.msi
